---
title: "I see you"
author: "Marcio Vakassugui"
date: "2022-05-10"
output: 
  html_document: 
    code_folding: hide
    theme: lumen
    toc: yes
    toc_float: yes
    smooth_scroll: no
    collapsed: yes
  html_notebook: 
    toc: yes
runtime: shiny
---

```{r setup }
#| include=FALSE

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  align = "center",
  fig.height = 7,
  fig.width = 14
)
```

```{r inclui figura jogo tabuleiro}
#| fig.align = "right",
#| out.width = "100%",
#| echo = FALSE,
#| out.width = 300 ,
#| out.height = 150,


knitr::include_graphics("http://1.bp.blogspot.com/_c7zUyhjdoVM/S3i8-RDd3II/AAAAAAAAAyY/9kngUbVrtVY/s320/olhar+avatar.jpg")
```

# Introdução

::: {align="justify" style="text-indent: 3em;"}
O IMDB, *Internet Move Database*, é uma das maiores bases pesquisáeis de dados sobre filmes e séries disponíveis para acesso para uso pessoal e não comercial fornecida por um dos mais respeitados *sites* de crítica popular de filmes e séries do mundo. Todos os usuários registrados no [Internet Movie DataBase](https://www.imdb.com/) podem avaliar os filmes, as séries e os documentários com notas de 1 a 10. Na sua página, é possivel encontrar as notas médias dos filmes, *trailers*,  a lista com as principais bilheterias da semana nos Estados Unidos, informações sobre o elenco e direção, resenhas de críticos, galerias de fotos e curiosidades.

Este trabalho de conclusão de curso objetiva a aplicação dos recursos abordados no curso "R para Ciência de Dados II", como organização de projetos, manipulação dos dados por meio dos pacotes *__dplyr__* e *__tidyr__*, de textos com  *__stringr__*, de datas e fatores com *__lubridade__* e *forcats* respectivamente, além de outras ferramentas e pacotes importantes como "*__expressões regulares__*", "*__funções anônimas__*", *__git__* e *__github__* e aplicações dos pacotes *__purrr__* e *__nse__*.

O conteúdo deste projeto é direcionado aos leitores interessados na sétima arte, que não abrem mão de assistir a um filme, na aconchegante poltrona de casa ou do cinema. Caso também tenha interesse em linguagem R, encontrará facilmente os códigos da manipulação dos dados e das gerações dos gráficos e tabelas.

Trarei algumas curiosidades encontradas nesta base de dados e de um filme me impressionou há 12 anos com o lançamento do seu capítulo 1 e que em dezembro de 2022 deve retornar às telas dos cinemas para o capítulo 2. 
:::


```{r carregar os pacotes}
#| echo = FALSE

library(lubridate)
library(tidyverse)
library(lubridate)
library(shiny)
library(ggthemes)
library(kableExtra)
library(ggtext)
library(forcats)
library(ggplot2)
library(readr)

```

```{r  Leitura das bases}
#| echo = FALSE

# remotes::install_github("curso-r/basesCursoR")
# imdb <- basesCursoR::pegar_base("imdb_completa")
# imdb_pessoas <- basesCursoR::pegar_base("imdb_pessoas")
# imdb_avaliacoes <- basesCursoR::pegar_base("imdb_avaliacoes")

imdb <- read_rds("../data-raw/imdb.rds")
imdb_avaliacoes <- read_rds("../data-raw/imdb_avaliacoes.rds")
#imdb_pessoas <- read_rds("../data-raw/imdb_pessoas.rds")
    
```

```{r manipulação de dados}
#| echo = FALSE

# alterar o tipo da variável data_lancamento de "char" para "date" -----------------------------

imdb <- imdb |>    
  mutate(
    data_lancamento = ymd(data_lancamento),                               # conversão para date.
  )
```

<br>

# Análises

::: {align="justify" style="text-indent: 3em;"}

As três bases analisadas (imdb, imdb_avaliacoes e imdb_pessoas) possuem em suas primeiras linhas, cabeçalhos com os nomes das variáveis. 

O *database* *__imdb__*  possui `r nrow(imdb)` filmes com `r ncol(imdb)` variáveis e conta com os dados de lançamentos entre 1894 a 2020.  Na tabela abaixo, relacionamos o dicionário com os nomes das variáveis e suas definições.

:::

<style type="text/css">
.tg  {border:none;border-collapse:collapse;border-color:#9ABAD9;border-spacing:0;}
.tg td{background-color:#EBF5FF;border-color:#9ABAD9;border-style:solid;border-width:0px;color:#444;
  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:4px 10px;word-break:normal;}
.tg th{background-color:#409cff;border-color:#9ABAD9;border-style:solid;border-width:0px;color:#fff;
  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:4px 10px;word-break:normal;}
.tg .tg-yspo{background-color:#022859;border-color:#ffffff;color:#ffffff;font-size:14px;font-weight:bold;text-align:left;
  vertical-align:top}
.tg .tg-0jgf{background-color:#D2E4FC;border-color:#ffffff;font-size:11px;text-align:left;vertical-align:top}
.tg .tg-pmdb{border-color:#ffffff;font-size:11px;text-align:left;vertical-align:top}
</style>
<table class="tg" style="undefined;table-layout: fixed; width: 850px">
<colgroup>
<col style="width: 142.005682px">
<col style="width: 142.005682px">
<col style="width: 566.005682px">
</colgroup>
<thead>
  <tr>
    <th class="tg-yspo">Variável</th>
    <th class="tg-yspo">Tipo</th>
    <th class="tg-yspo">Descrição</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0jgf">id_filme</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">identificador alfanumérico exclusivo do título</td>
  </tr>
  <tr>
    <td class="tg-pmdb">titulo</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">nome da obra em materiais promocionais na data do lançamento</td>
  </tr>
  <tr>
    <td class="tg-0jgf">titulo_original</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">nome original da obra, no idioma original</td>
  </tr>
  <tr>
    <td class="tg-pmdb">ano</td>
    <td class="tg-pmdb">dbl</td>
    <td class="tg-pmdb">ano da produção</td>
  </tr>
  <tr>
    <td class="tg-0jgf">data_lancamento</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">data do lançamento do filme ou a data de início da série</td>
  </tr>
  <tr>
    <td class="tg-pmdb">genero</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">inclui até três gêneros associados ao título</td>
  </tr>
  <tr>
    <td class="tg-0jgf">duracao</td>
    <td class="tg-0jgf">dbl</td>
    <td class="tg-0jgf">tempo de execução em minutos</td>
  </tr>
  <tr>
    <td class="tg-pmdb">pais</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">país</td>
  </tr>
  <tr>
    <td class="tg-0jgf">idioma</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">idioma</td>
  </tr>
  <tr>
    <td class="tg-pmdb">orcamento</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">orçamento</td>
  </tr>
  <tr>
    <td class="tg-0jgf">receita</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">receita</td>
  </tr>
  <tr>
    <td class="tg-pmdb">receita_eua</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">receita nos EUa</td>
  </tr>
  <tr>
    <td class="tg-0jgf">nota_imdb</td>
    <td class="tg-0jgf">dbl</td>
    <td class="tg-0jgf">nota média obtida pela obra nas avaliações dos usuários</td>
  </tr>
  <tr>
    <td class="tg-pmdb">num_avaliacoes</td>
    <td class="tg-pmdb">dbl</td>
    <td class="tg-pmdb">total de avaliações realizadas para cada título</td>
  </tr>
  <tr>
    <td class="tg-0jgf">direcao</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">diretor(es)</td>
  </tr>
  <tr>
    <td class="tg-pmdb">roteiro</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">roteirista(s)</td>
  </tr>
  <tr>
    <td class="tg-0jgf">producao</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">empresa produtora</td>
  </tr>
  <tr>
    <td class="tg-pmdb">elenco</td>
    <td class="tg-pmdb">chr</td>
    <td class="tg-pmdb">nomes dos integrantes do elenco</td>
  </tr>
  <tr>
    <td class="tg-0jgf">descricao</td>
    <td class="tg-0jgf">chr</td>
    <td class="tg-0jgf">sinopse da obra</td>
  </tr>
  <tr>
    <td class="tg-pmdb">num_criticas_publico</td>
    <td class="tg-pmdb">dbl</td>
    <td class="tg-pmdb">total de críticas recebidas do público</td>
  </tr>
  <tr>
    <td class="tg-0jgf">num_criticas_critica</td>
    <td class="tg-0jgf">dbl</td>
    <td class="tg-0jgf">total de críticas recebidas dos críticos</td>
  </tr>
</tbody>
</table>


## Um mês muito especial

```{r preparacao da base e tabela mes com mairo numero de lancamentos de filmes}
## Manipulação da base para determinação do mês com maior número de lançamentos de filmes

imdb <- imdb |>                                              # converte variável para tipo date.
  mutate(
    data_lancamento = ymd(data_lancamento))                            


imdb_datas <- imdb |>                     # retorna mes como oprimeiro dia do mês de lançamento.
  mutate(
    mes = floor_date(data_lancamento, "month")      
  )

mes_maior_lancamento <- imdb_datas |>           # Obtém o mês com o maior número de lançamentos.
  group_by(mes) |>        
  summarise(qte = n()) |>             
  separate(  
    col = mes,                         
    into = c("ano", "mes")) |>                                     
  drop_na() |> 
  slice_max(
    order_by = qte
  ) 

## Tabela com  os dados do mês com o maior número de lançamentos

mes_maior_lancamento |>                                                                
kbl(
  align = "l",                                              # alinhamento do texto do cabeçalho.
  col.names = c("Ano de Lançamento",                              # define o nome das variáveis.
                "Mês", 
                "Quantidade de Filmes Lançados"),
  caption = "Outubro de 2018",
  full_width = TRUE
) |> 
  kable_styling(                                            # altera as configurações da tabela.
    html_font = "get_schwifty",
    bootstrap_options = "basic",
    font_size = 10,
    full_width = TRUE, 
    fixed_thead = list(enabled = TRUE, background = "#B2DDF7")
  ) |> 
  column_spec(1,                                          # altera as configurações das colunas.
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "3cm"
              ) |>      
  column_spec(2, 
              bold = FALSE,
              background = "#022859",
              color = "#FFFFFF",
              width = "3cm"
              ) |>
  column_spec(3,
              bold = FALSE,
              background = "#022859",
              color = "#FFFFFF",
              width = "4cm"
              ) |> 
  footnote(general = "Base de dados IMDB (Internet Movie Database).",
           footnote_as_chunk = TRUE,
           fixed_small_size = TRUE,
           general_title = "Fonte:",
           )

```



::: {align="justify" style="text-indent: 3em;"}
Em Outubro de `r mes_maior_lancamento$ano`, foram lançados `r mes_maior_lancamento$qte` filmes. Este foi o mês em toda a história da indústria cinematográfica com o maior número de lançamentos em um mês. Na tabela abaixo listamos os 30 filmes lançados nesta data em ordem descrescente de suas notas médias IMDB. Consideramos somente os filmes com numero de avaliações superiores a 10000 pessoas.
:::

```{r relacao de filmes do mes com maior numero de lancamentos }

## Manipulação da base para obtenção da relação dos 30 filmes por ranking 

mes_maior_lancamento <- imdb_datas |>                 # lista dos 30 filmes com melhor ranking.
  group_by(mes) |>        
  summarise(qte = n(),
            titulo,
            data_lancamento, 
            nota_imdb, 
            num_avaliacoes,
            pais) |>
  filter(mes == "2018-10-1" & num_avaliacoes >= 10000) |> 
  arrange(desc(nota_imdb)) |> 
  slice_head(n=30)

mes_maior_lancamento$mes <- NULL                                          # Exclusão de colunas. 
mes_maior_lancamento$qte <- NULL

## Tabela com os 30 filmes com melhores rankings

mes_maior_lancamento |>                                                               
kbl(
  align = "l",                                              # alinhamento do texto do cabeçalho.
  col.names = c("título",                                         # define o nome das variáveis.
                "lançamento", 
                "nota",
                "avaliações",
                "país"),
  caption = "Top filmes ",
  ) |> 
  kable_styling(                                            # altera as configurações da tabela.
    bootstrap_options = "basic",
    html_font = "get_schwifty",
    font_size = 10,
    full_width = TRUE, 
    fixed_thead = list(enabled = TRUE, background = "#B2DDF7"),
    ) |> 
  column_spec(1,                                          # altera as configurações das colunas.
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "3cm",
              ) |>      
  column_spec(2, 
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "1cm"
              
              ) |>
  column_spec(3,
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "1cm"
              ) |> 
  column_spec(4,
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "1cm"
              ) |> 
  column_spec(5,
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "4cm"
              ) |> 
  footnote(general = "Base de dados IMDB (Internet Movie Database).",
           footnote_as_chunk = TRUE,
           fixed_small_size = TRUE,
           general_title = "Fonte:",
           )
```

::: {align="justify" style="text-indent: 3em;"}
Ratsasan é um filme de terror e foi produzido em língua tamil. Conta a história de de um aspirante a diretor de cinema que se torna policial após a morte de seu pai e tenta rastrear um serial *killer*.
:::

<br>

## Um dia muito especial

::: {align="justify" style="text-indent: 3em;"}
E qual seria o dia com a maior quantidade de filmes lançados? Podemos fazer esta análise. Novamente, código e resposta abaixo.
:::

```{r dia com o maior numero de lancamento}

## Manipulação da base para a obtencão do dia com o maior número de lançamentos

dia_maior_lancamento <- imdb |> 
  mutate(dia = day(data_lancamento)) |> 
  group_by(dia) |> 
  summarise(qtde = n()) |> 
  drop_na() |> 
  slice_max(order_by = qtde)

## Tabela com os dados do dia com maior número de lançamentos

dia_maior_lancamento |>                                                                
  kbl(
    align = "l",                                            # alinhamento do texto do cabeçalho.
    col.names = c("Dia", 
                  "Quantidade de Filmes Lançados"),                 # define o nome das colunas.
  caption = "Primeiro dia ",
    ) |> 
  kable_styling(                                            # altera as configurações da tabela.
    html_font = "get_schwifty",
    bootstrap_options = "basic",
    font_size = 10,       
    full_width = TRUE, 
    fixed_thead = list(enabled = TRUE, background = "#B2DDF7")
    ) |> 
  column_spec(1,
              bold = FALSE,
              background = "#022859",
              color = "#FFFFFF",
              width = "5cm"
              ) |>      
  column_spec(2, 
              bold = FALSE,
              background = "#022859",
              color = "#FFFFFF",
              width = "5cm"
              ) |> 
  footnote(general = "Base de dados IMDB (Internet Movie Database).",
           footnote_as_chunk = TRUE,
           fixed_small_size = TRUE,
           general_title = "Fonte:",
           )
```

::: {align="justify" style="text-indent: 3em;"}
Os `r dia_maior_lancamento$dia`ºs dia dos mêses são os preferidos pelas produtoras para os lançamentos. Foram `r dia_maior_lancamento$qtde` estréias neste dia ao longo dos anos. Seguido pelos dias 15 com 2831, 14 com 2728 e 25 com 2727 filmes.
:::

,BR.

## Os paises com maior número de filmes

::: {align="justify" style="text-indent: 3em;"}
De acordo com a base IMDB temos a seguinte relação dos países com mais filmes:
:::

```{r top 5 de paises com mais filmes na base}

## Manipulação da base para a obtencão dos 5 países com mais filmes na base

top_5_paises <- imdb |> 
  group_by(pais) |> 
  summarise(qtde = n()) |> 
  arrange(desc(qtde)) |> 
  slice_head(n=5)

## Tabela com os dados do dia com maior número de lançamentos

top_5_paises |>                                                                        
  kbl(
    align = "l",                                            # alinhamento do texto do cabeçalho.
    col.names = c("País",                                           # define o nome das colunas.
                  "Quantidade de Filmes Lançados"),
    caption = "Top 5 países"
    ) |> 
  kable_styling(
    html_font = "get_schwifty",
    bootstrap_options = "basic",
    font_size = 10,       
    full_width = TRUE, 
    fixed_thead = list(enabled = TRUE, background = "#B2DDF7")
    ) |> 
  column_spec(1,                                            # altera as configurações da tabela.
              bold = FALSE,
              background = "#022859", 
              color = "#FFFFFF",
              width = "5cm"
              ) |>      
  column_spec(2, 
              bold = FALSE,
              background = "#022859",
              color = "#FFFFFF",
              width = "5cm"
              ) |> 
  footnote(general = "Base de dados IMDB (Internet Movie Database).",
           footnote_as_chunk = TRUE,
           fixed_small_size = TRUE,
           general_title = "Fonte:",
           )


```

```{r grafico 01}
#| echo = TRUE,
#| fig.height = 7,
#| fig.width = 14,
#| out.width = 1300,
#| out.height = 700


top_20_paises <- imdb |> 
  group_by(pais) |> 
  summarise(qtde = n()) |> 
  arrange(desc(qtde)) |> 
  slice_head(n=16)

cor <- c(                                         # paleta  de cores para os elementos gráficos.
  "#c42847", "#ffad05", "#7d5ba6", "#00bbf9", "#2bc016",
  "#B2DDF7", "#B2DDF7", "#B2DDF7", "#B2DDF7", "#B2DDF7",
  "#B2DDF7", "#B2DDF7", "#B2DDF7", "#B2DDF7", "#B2DDF7",
  "#365F6D"
)

top_20_paises |> 
  ggplot(aes(y = fct_reorder(pais, 
                             qtde, 
                             .desc = FALSE),
             x = qtde, 
             label = qtde
             )
         ) +
    geom_col(fill = cor)+
  geom_label(                                                              # formatar os labels.
    size = 3.8, 
    alpha = 0,
    label.size = NA,    
    fontface = "bold",    
    color = "#FFFFFF",
    hjust = -0.3
  ) +
   geom_curve(aes(y = 14,                                        # formatar curva para anotação.
                  x = 6000,  
                  xend = 15000,     
                  yend = 10   
   ),
   arrow = arrow(                                                    # formatar a seta da curva.
     type = "closed",          
     length = unit(0.02, "npc")     
   ),
   curvature = -0.14,  
   color = "#B2DDF7"   
  ) +
  geom_curve(aes(y = 1,                                          # formatar curva para anotação.
                 x = 2000,  
                 xend = 9500,     
                 yend = 2   
  ),
  arrow = arrow(                                                     # formatar a seta da curva.
    type = "closed",          
    length = unit(0.02, "npc")     
  ),
  curvature = 0,  
  color = "#B2DDF7"
  )+
  labs(
    title = "Países com maior quantidade de lançamentos de filmes",
    subtitle = "Destaque para os cinco paises com maiores notas",
    x = "Quantidade de filmes lançados",
    y = "Paises"
  )+
  scale_x_continuous(
    breaks = seq(0, 29000,10000),
    limits = c(0,29000)
  )+
  theme_classic()+
  theme(
    panel.background = element_rect(fill = "#022859"),                       # fundo do gráfico.
    plot.background = element_rect(fill = "#B2DDF7"),             # fundo da moldura retangular.
    legend.position = "none",
    plot.margin = unit(c(1, 1.5, 0.5, 1), "cm"),
    plot.title = element_markdown(                                          # título do gráfico.
      size = 32,
      face = "plain",
      family = "NationalHero!",
      hjust = 0.5,
      margin = unit(c(0.3, 0, 0.5, -0,2), "cm")
    ), 
    plot.subtitle = element_markdown(
      size = 14,
      hjust = 0,
      family = "arial",
      margin = unit(c(0, 0, 0.5, 0), "cm")
    ),
    text = element_text(                                                    # textos do gráfica.
      family = "arial",    
      color = "#022859",
      size = 11,
      hjust = 0,
      face = "bold"
    ),
    axis.text.x = element_text(                                           # texto do eixo x.
      color = "#022859",       
      size = 11,
      face = "bold",
      family = "Rio2016",
      margin = unit(c(0.5, 0, 0.5, 0), "cm")  
    ),
    axis.text.y = element_markdown(                                       # texto do eixo y.
      color = "#022859",    
      size = 13,
      face = "bold",
      family = "Rio2016", 
      margin = unit(c(0, 0.5, 0, 0.5), "cm")
    ),
    axis.ticks.x = element_line(color = "#1F1F1F"),                         # ticks do eixo x.
    axis.line.x = element_line(color = "#1F1F1F"),                   # cor da linha do eixo x.
    axis.ticks.y = element_line(color = "#1F1F1F"),             # padrões dos ticks do eixo x.
    axis.line.y = element_line(
      color = "#000000",                                           # cor da linha do eixo x.
      size = 0.4,
    ),
    axis.title = element_text(                                    # texto do título do eixo x.
      face = "bold",    
      size = 13,
      hjust = 0.5,
    )
  )+    
  annotate( "text",
            x = 21000, y = 9, label = "Relação dos cinco países com mais lançamentos 
            registrados na base IMDB",
            color = "#B2DDF7", 
            size = 4,
            family = "arial",
            fontface = "bold"
  )+
  annotate( "text",
            x = 14000, y = 2, label = "Décima sexta posição do Brasil",
            color = "#B2DDF7", 
            size = 4,
            family = "arial",
            fontface = "bold"
  )

```

::: {align="justify" style="text-indent: 3em;"}
O Brasil ocupa a 16ª posição com 736 filmes.

continuar
:::
